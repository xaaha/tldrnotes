---
import Mainlayout from "@layouts/Mainlayout.astro";
import PostHeader from "@components/PostHeader.astro";
import PostFooter from "@components/PostFooter.astro";

const { frontmatter } = Astro.props;
const { category, date, description, image, title } =
  frontmatter as Frontmatter;
---

<Mainlayout {title} {description}>
  <PostHeader {title} {date} {category} {image} />
  <div class="post-content">
    <div class="content">
      <script>
        // Wait for the page to be fully loaded
        document.addEventListener("DOMContentLoaded", () => {
          const copyButtonLabel = "Copy";

          // Target all code blocks generated by Astro's Shiki integration
          const codeBlocks = document.querySelectorAll("pre.astro-code");

          codeBlocks.forEach((codeBlock) => {
            // Create a div to wrap the code block
            const wrapper = document.createElement("div");
            wrapper.style.position = "relative";

            // Create the copy button
            const copyButton = document.createElement("button");
            copyButton.className = "copy-code-button";
            copyButton.textContent = copyButtonLabel;

            // Wrap the code block with the new div
            codeBlock.parentNode?.insertBefore(wrapper, codeBlock);
            wrapper.appendChild(codeBlock);

            // FIX: Append the button to the wrapper, not the code block
            wrapper.appendChild(copyButton);

            // Add click event listener to the button
            copyButton.addEventListener("click", async () => {
              const codeElement = codeBlock.querySelector("code");
              if (codeElement) {
                const textToCopy = codeElement.innerText;
                try {
                  await navigator.clipboard.writeText(textToCopy);
                  copyButton.textContent = "Copied!";
                  copyButton.classList.add("copied");
                  // Reset button after clicking
                  setTimeout(() => {
                    copyButton.textContent = copyButtonLabel;
                    copyButton.classList.remove("copied");
                  }, 700);
                } catch (err) {
                  console.error("Failed to copy text: ", err);
                  copyButton.textContent = "Error";
                }
              }
            });
          });
        });
      </script>

      <slot />
    </div>
    <div class="sidebar"></div>
  </div>
  <PostFooter {category} />
</Mainlayout>

<style>
  :global(table) {
    border-collapse: collapse;
    width: 100%; /* take up full width of its container */
    margin-block: 1.5em; /* space above and below the table */
  }

  :global(table caption) {
    font-size: 1.2em;
    font-weight: bold;
    margin-block-end: 1em;
  }

  :global(table td),
  :global(table th) {
    border: 1px solid hsl(var(--txt) / 0.25);
    padding: 0.5em 1em;
    text-align: left;
  }

  :global(table th) {
    background-color: hsl(var(--muted) / 0.5);
  }
</style>
